sourceCompatibility = 1.8
targetCompatibility = 1.8

ext {
    dottyLibraryPath = file(System.getenv("DOTTY_HOME") + "/lib")
    dottyLibraryFiles = files { dottyLibraryPath.listFiles() }
    dotcLibraryFiles = dottyLibraryFiles.filter { File f ->
        f.name.startsWith("scala-library") ||
        f.name.startsWith("scala-xml") ||
        f.name.startsWith("scala-asm") ||
        f.name.startsWith("compiler-interface") ||
        f.name.startsWith("dotty-interfaces") ||
        f.name.startsWith("dotty-library") ||
        f.name.startsWith("dotty-compiler")
    }
    scalaSourceTree = fileTree(dir: "/src/main/scala", include: "**/*.scala")
    jarLibraryTree = fileTree(dir: "/lib", include: "**/*.jar")
    targetDir = file("/target")
    classesDir = file("${targetDir}/classes")
    javaMainDir = file("${classesDir}/java/main")
    runtimeClasspath = files(jarLibraryTree, classesDir, javaMainDir)
}

clean.doLast {
    targetDir.deleteDir()
}

task compileDotty(type: JavaExec) {
    dependsOn compileJava

    classpath dotcLibraryFiles + runtimeClasspath
    String sources = scalaSourceTree.files.join("\" \"").replaceAll("\\\\", "/")

    main "dotty.tools.dotc.Main"

    jvmArgs "-Dscala.usejavacp=true", "-Dfile.encoding=UTF-8"

    //args "-version"
    args "-d", classesDir, sources
}

compileDotty.doFirst {
    if (!classesDir.exists()) classesDir.mkdirs()
}

sourceSets {
    main {
        java {
            buildDir targetDir
        }
    }
}

build {
    dependsOn compileDotty
}

run {
    dependsOn build

    classpath runtimeClasspath

    jvmArgs "-Xbootclasspath/a:${dottyLibraryFiles.getAsPath()}", "-Dfile.encoding=UTF-8"

    main mainClassName
    args ''
    //systemProperty "message" "Hello"
}

repositories {
    mavenCentral()
}
